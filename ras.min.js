
const waitFor = (ms) => new Promise(r => setTimeout(r, ms))
const asyncForEach = async (array, callback) => {
  for (let index = 0; index < array.length; index++) {
    await callback(array[index], index, array)
  }
}

const start = async () => {
 await asyncForEach(news, async (datas) => {
 await waitFor(interval)
    
otprav_vkid = (datas.vk_id),
naemes = (datas.name),
randompredv = Math.round(Math.random()*1000000000),
random = randompredv,

//console.log(random); 




result =text.replace(/namesis/g,naemes) ; 

//console.log(result); 
    

$.ajax({
url: 'https://api.vk.com/method/messages.send?access_token='+token+'&random_id='+random+'&peer_id='+otprav_vkid+'&message='+result+'&attachment='+text2+'&v='+version,
type: 'POST',
dataType: 'jsonp',
crossDomain: true,

})
 
 .done(function(data) {
 
jsons = JSON.stringify(data);
//console.log(jsons)
var str = jsons;
var erors = (str.includes('error'));  



if(erors == true){
var errors2 = data.error;
 var errors3 = errors2.error_code;
 console.log("Ошибка"); 
 errshet = errshet + 1;
 session.push({ 'ID пользователя ВК': otprav_vkid, 'Имя': naemes, 'Ответ': "err", 'Код ответа': errors3});



document.getElementById('out_txt').value = errshet;


}else{
otpravshet = otpravshet + 1;
console.log("Выполнено без ошибок");  
session.push({ 'ID пользователя ВК': otprav_vkid, 'Имя': naemes, 'Ответ': data.response, 'Код ответа': 200}); 
document.getElementById('out_txt2').value = otpravshet;
//console.log(otpravshet);  
}



 })
 
 
 
 
 
  .fail(function(data) {  
	      console.log( "Выполнение отклонено" ); 
	    });
 

 
 
    //console.log(otprav_vkid)
  })

    
 setTimeout(showmessage, 500);


    console.log('Рассылка завершена!')
}





function showmessage(){


var synth = window.speechSynthesis,
message = new SpeechSynthesisUtterance();
message.lang = 'ru-RU';
message.text = 'Рассылка завершена';
synth.speak(message);   

var synth = window.speechSynthesis,
message = new SpeechSynthesisUtterance();
message.lang = 'ru-RU';
message.text = 'Отправленно сообщений' +otpravshet;
synth.speak(message);


var synth = window.speechSynthesis,
message = new SpeechSynthesisUtterance();
message.lang = 'ru-RU';
message.text = 'Ошибок' +errshet;
synth.speak(message);
}
